<!DOCTYPE HTML>
<html>

<head>
    <style>
    </style>
    <!-- standard flatbuffers js API -->
    <script src="flatbuffers.js"></script>
    <!-- generated by flatbuffers flatc-command, from messages.fbs -->
    <script src="messages_generated.js"></script>
    <!-- our websockets messaging framework -->
    <script src="messages.js"></script>

    <!-- paper app -->
    <script src="paper.js"></script>

    <!-- external frameworks -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>

    <script>


        function ping(msg) {
            m.builder.clear();
            m.builder.finish(
                event.Message.createMessage(
                    m.builder,
                    event.EventUnion.Echo,
                    event.Echo.createEcho(
                        m.builder,
                        123,
                        456,
                        m.builder.createString("payload")
                    )
                )
            );
            m.send();
        }


        function join(id) {
            m.add_event(
                event.EventUnion.Join,
                event.Join.createJoin(
                    m.builder,
                    m.builder.createString(id)
                ));

            m.send();

        }

        window.addEventListener('load', (event) => {

            paper.start();

            //start websocket messaging:
            m.start(function () {
                //(re)-connected
                join(document.location.search);


            });

        })

        // m.handlers[event.EventUnion.Echo] = function (msg) {
        //     // console.log(msg);
        //     ping();
        // }


        m.handlers[event.EventUnion.Error] = (msg, event_index) => {
            error = msg.events(event_index, new event.Error());
            console.error("Server reports error: " + error.description());
        }


        //create/get cursor svg object for specified client
        function getCursor(clientId) {
            let drawing = paper.svg_element;
            let svgns = 'http://www.w3.org/2000/svg';
            var cursor = document.getElementById('cursor' + clientId);
            if (cursor == null) {
                //create a group for this client's cursor
                cursor = document.createElementNS(svgns, 'g');
                cursor.setAttribute('id', 'cursor' + clientId);
                cursor.setAttribute('stroke', '#000000');
                cursor.setAttribute('stroke-width', '10');
                drawing.appendChild(cursor);

                //add drawing to the cursor group
                var e = document.createElementNS(svgns, 'line');
                e.setAttribute('x1', '-200');
                e.setAttribute('x2', '+200');
                e.setAttribute('y1', '0');
                e.setAttribute('y2', '0');
                cursor.appendChild(e);

                var e = document.createElementNS(svgns, 'line');
                e.setAttribute('x1', '0');
                e.setAttribute('x2', '0');
                e.setAttribute('y1', '-200');
                e.setAttribute('y2', '+200');
                cursor.appendChild(e);

                //create text element
                var e = document.createElementNS(svgns, 'text');
                e.setAttribute('id', 'cursorName' + clientId);
                e.setAttribute('x', '0');
                e.setAttribute('y', '300');
                e.setAttribute('font-size', '200');
                e.setAttribute('font-weight', 'bold');
                e.setAttribute('stroke', '#000000');
                e.setAttribute('fill', '#000000');
                cursor.appendChild(e);

                //add the actual text
                var textNode = document.createTextNode("(unknown)", true);
                e.appendChild(textNode);

            }
            return (cursor);
        }


        m.handlers[event.EventUnion.Join] = (msg, event_index) => {
            join = msg.events(event_index, new event.Join());
            console.log("Join shared session", join.id(), "as client", join.clientId());
            paper.client_id = join.clientId();

        }


        m.handlers[event.EventUnion.Cursor] = (msg, event_index) => {
            cursor = msg.events(event_index, new event.Cursor());

            client_id = cursor.clientId();
            csvg = getCursor(client_id);
            csvg.setAttribute('transform', 'translate(' + cursor.x() + ',' + cursor.y() + ')');

            // console.log(cursor.x(), cursor.y());

        }


    </script>

</head>
<body>

<ons-page>

    <ons-toolbar modifier="material">
        <div class='left'>
            <ons-toolbar-button onclick="paper.onClickToolPointer()">
                <ons-icon icon='fa-hand-point-up' class="fas"></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button onclick="paper.onClickToolSelect()">
                <ons-icon icon='fa-mouse-pointer'></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button onclick="paper.onClickToolPolyline()">
                <ons-icon icon='fa-pen'></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button onclick="paper.onClickToolSquare()">
                <ons-icon icon='fa-square' class="far"></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button onclick="paper.onClickToolCircle()">
                <ons-icon icon='fa-circle' class="far"></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button onclick="paper.onClickToolEraser()">
                <ons-icon icon='fa-eraser'></ons-icon>
            </ons-toolbar-button>

            <ons-toolbar-button></ons-toolbar-button>

            <ons-toolbar-button icon='undo'
                                onclick="paper.onClickUndo()"></ons-toolbar-button>
            <ons-toolbar-button icon='redo'
                                onclick="paper.onClickRedo()"></ons-toolbar-button>
            <ons-toolbar-button icon='history'
                                onclick="paper.onClickHistory()"></ons-toolbar-button>
        </div>

    </ons-toolbar>


    <!-- Your page content here. -->
    <svg style=" width: 10000; height: 10000">

    </svg>

</ons-page>


</body>

</html>